

# Author: Neil Beadle
# Adds RFC2136 DDNS templates to the EdgeOS based Edge Routers

VERSION="1.2"

CDIR=$(pwd)
RFC2136="rfc2136.bkp"
TITLE="  Install Dynamic DNS (DDNS) RFC 2136 Integration v${VERSION}  "
OPTIONS=('(I)nstall Integration' '(R)emove Integration' '(P)urge Stale Files' '(B)ackup Integration' '(Q)uit Install')

# Make sure script is run as ubnt admin
if [[ ${EUID} -eq 0 ]]; then
	echo 'This script must be run as the ubnt admin user, not root!'
	exit 1
fi

# Set up the EdgeOS environment
source /opt/vyatta/etc/functions/script-template
shopt -s expand_aliases
alias show='_vyatta_op_run show'
alias run='/opt/vyatta/bin/vyatta-op-cmd-wrapper'
alias check='/bin/cli-shell-api'

atexit () {
	tput cnorm
}
trap atexit exit ${?}

install_menu ()
{
	local options=("$@")
	read -p "Enter number or initial letter of menu option => " choice

	case ${choice} in
		0|I|i)	echo "Installing RFC 2136 DDNS integration v${VERSION}"
						./setup
						pause
				;;
		1|R|r)	./Remove_RFC2136
						pause
				;;
		2|P|r)	sudo ./ubnt-cln-cfg-orphans.sh
						pause
				;;
		3|B|b)	run show configuration commands | grep "set service dns dynamic interface .* rfc2136" &> /dev/null
						if [[ $? == 0 ]]
						then
							ISODATE=$(date +'%FT%H%M%S')
							RESULT=$(run show configuration commands | grep rfc2136 > "/config/user-data/${RFC2136}.cmds")
							tput setaf 2
							echo -ne "\nRFC 2136 DDNS integration v${VERSION} configuration backed up to /config/user-data/${RFC2136}.${ISODATE}.cmds\n\n"
							tput setaf 7
							echo -ne "To restore, run:\n\tconfigure\n\tsource /config/user-data/${RFC2136}.${ISODATE}.cmds\n\tcommit\n\tsave\n\texit\n\n" | fold -s -w ${COLUMNS}
						else
							tput setaf 1
							echo -ne "\nRFC 2136 DDNS integration isn't configured, nothing to backup!\n\n"
							tput setaf 7
						fi
						pause
				;;
				*)	break
				;;
	esac
}

export TMPDIR=`mktemp -d /tmp/selfextract.XXXXXX`

ARCHIVE=`awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' $0`

tail -n+${ARCHIVE} $0 | tar xz -C ${TMPDIR}

cd ${TMPDIR}

while true
do
	show_menu "${TITLE}" "${OPTIONS[@]}"
	install_menu "${OPTIONS[@]}"
done

cd ${CDIR}
sudo rm -rf ${TMPDIR}

exit 0

__ARCHIVE_BELOW__
